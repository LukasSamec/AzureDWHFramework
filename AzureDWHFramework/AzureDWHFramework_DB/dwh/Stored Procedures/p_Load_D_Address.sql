CREATE PROCEDURE dwh.p_Load_D_Address@ETLLogID BIGINT ASDECLARE @ETLTableLoadLogID BIGINTDECLARE @ErrorMessage NVARCHAR(MAX)DECLARE @DateTime DATETIME2DECLARE @InsertedCount INT = 0DECLARE @DeletedCount INT = 0DECLARE @UpdatedCount INT = 0BEGIN TRYEXEC log.p_WriteETLTableLoadLog @ETLLogID = @ETLLogID, @Name = 'dwh.p_load_D_Address', @TargetSchemaName = 'dwh ', @TargetTableName = 'D_Address', @Type = 'Stored procedure', @Status = 1, @StatusDescription = 'Running', @NewETLTableLoadLogID = @ETLTableLoadLogID OUTPUTCREATE TABLE #D_Address ( Change NVARCHAR(255), [AddressCode] nvarchar(255) NOT NULL, [AddressLine1] nvarchar(255) NOT NULL, [AddressLine2] nvarchar(255) NOT NULL, [City] nvarchar(255) NOT NULL,[InsertedETLLogID] BIGINT NOT NULL,[UpdatedETLLogID] BIGINT NOT NULL,[Active] BIT NOT NULL )IF NOT EXISTS (SELECT 1 FROM dwh.D_Address WHERE AddressID = -1)BEGINSET IDENTITY_INSERT dwh.D_Address ON;INSERT INTO dwh.D_Address(AddressID,AddressCode,AddressLine1,AddressLine2,City,InsertedETLLogID,UpdatedETLLogID,Active)VALUES(-1,-1,-1,-1,-1,@ETLLogID,@ETLLogID,1)SET IDENTITY_INSERT dwh.D_Address OFF;ENDMERGE dwh.D_Address AS targetUSING(SELECT AddressID, AddressLine1, AddressLine2, CityFROM stage_csv.Address) AS sourceON (target.AddressCode = source.AddressID)WHEN MATCHED THEN UPDATE SETtarget.AddressLine1 = source.AddressLine1,target.AddressLine2 = source.AddressLine2,target.City = source.City,target.UpdatedETLLogID = @ETLLogID,target.Active = 1WHEN NOT MATCHED THEN INSERT(AddressCode,AddressLine1,AddressLine2,City,InsertedETLLogID,UpdatedETLLogID,Active)VALUES(source.AddressID,source.AddressLine1,source.AddressLine2,source.City,@ETLLogID,@ETLLogID,1)WHEN NOT MATCHED BY SOURCE AND target.Active = 1 AND target.AddressID <> -1 THENUPDATE SET target.Active = 0OUTPUT $action,source.AddressID,source.AddressLine1,source.AddressLine2,source.City,@ETLLogID, @ETLLogID, 1 INTO #D_Address;SELECT @InsertedCount = COUNT(1) FROM #D_Address WHERE Change = 'INSERT'SELECT @UpdatedCount = COUNT(1) FROM #D_Address WHERE Change = 'UPDATE'SELECT @DeletedCount = COUNT(1) FROM #D_Address WHERE Change = 'DELETE'SELECT @DateTime = GETUTCDATE()EXEC log.p_UpdateETLTableLoadLog @ETLTableLoadLogID, 2, 'Finished', @InsertedCount, @UpdatedCount, @DeletedCountEND TRYBEGIN CATCHSELECT @DateTime = GETUTCDATE()SELECT @ErrorMessage = ERROR_MESSAGE()EXEC log.p_UpdateETLTableLoadLog @ETLTableLoadLogID, 3, 'Failed', @InsertedCount, @UpdatedCount, @DeletedCount, @ErrorMessageEXEC log.p_UpdateETLLog @ETLLogID, 3, 'Failed';THROWEND CATCH