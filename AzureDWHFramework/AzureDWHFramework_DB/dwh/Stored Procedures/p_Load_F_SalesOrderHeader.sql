CREATE PROCEDURE dwh.p_Load_F_SalesOrderHeader@ETLLogID BIGINT ASDECLARE @ETLTableLoadLogID BIGINTDECLARE @ErrorMessage NVARCHAR(MAX)DECLARE @DateTime DATETIME2DECLARE @InsertedCount INT = 0DECLARE @DeletedCount INT = 0DECLARE @UpdatedCount INT = 0DECLARE @SummaryOfChanges TABLE (ID INT IDENTITY(1,1), Change NVARCHAR(20), Code INT) BEGIN TRYEXEC log.p_WriteETLTableLoadLog @ETLLogID,'dwh.p_load_F_SalesOrderHeader', 'dwh ', 'F_SalesOrderHeader','Stored procedure', 1, 'Running', @ETLTableLoadLogID OUTPUTINSERT INTO @SummaryOfChanges (Change, Code) VALUES ('DELETE', (SELECT COUNT(*) FROM dwh.F_SalesOrderHeader))TRUNCATE TABLE dwh.F_SalesOrderHeaderINSERT INTO dwh.F_SalesOrderHeader(SalesOrderID,OrderDateID,DueDateID,ShipDateID,SalesPersonID,BillAddressID,ShipAddressID,SubTotal,TaxAmt,Freight,InsertedETLLogID,UpdatedETLLogID,Active)SELECTSalesOrderID,ISNULL(dwhDateOrderDate.DateID, -1),ISNULL(dwhDateDueDate.DateID, -1),ISNULL(dwhDateShipDate.DateID, -1),ISNULL(dwhSalesPersonSalesPersonID.SalesPersonID, -1),ISNULL(dwhAddressBillToAddressID.AddressID, -1),ISNULL(dwhAddressShipToAddressID.AddressID, -1),SubTotal,TaxAmt,Freight,@ETLLogID,@ETLLogID,1FROM stage_onpremisedb.SalesOrderHeader stage_onpremisedbSalesOrderHeaderLEFT JOIN dwh.D_SalesPerson dwhSalesPersonSalesPersonID ON dwhSalesPersonSalesPersonID.SalesPersonCode = stage_onpremisedbSalesOrderHeader.SalesPersonIDLEFT JOIN dwh.D_Address dwhAddressBillToAddressID ON dwhAddressBillToAddressID.AddressCode = stage_onpremisedbSalesOrderHeader.BillToAddressIDLEFT JOIN dwh.D_Address dwhAddressShipToAddressID ON dwhAddressShipToAddressID.AddressCode = stage_onpremisedbSalesOrderHeader.ShipToAddressIDLEFT JOIN dwh.D_Date dwhDateOrderDate ON dwhDateOrderDate.Code = stage_onpremisedbSalesOrderHeader.OrderDateLEFT JOIN dwh.D_Date dwhDateDueDate ON dwhDateDueDate.Code = stage_onpremisedbSalesOrderHeader.DueDateLEFT JOIN dwh.D_Date dwhDateShipDate ON dwhDateShipDate.Code = stage_onpremisedbSalesOrderHeader.ShipDateINSERT INTO @SummaryOfChanges (Change, Code) VALUES ('INSERT', (SELECT COUNT(*) FROM dwh.F_SalesOrderHeader))SELECT @InsertedCount = COUNT(1) FROM @SummaryOfChanges WHERE Change = 'INSERT'SELECT @UpdatedCount = 0SELECT @DeletedCount = COUNT(1) FROM @SummaryOfChanges WHERE Change = 'DELETE'SELECT @DateTime = GETUTCDATE()EXEC log.p_UpdateETLTableLoadLog @ETLTableLoadLogID, 2, 'Finished', @InsertedCount, @UpdatedCount, @DeletedCountEND TRYBEGIN CATCHSELECT @DateTime = GETUTCDATE()SELECT @ErrorMessage = ERROR_MESSAGE()EXEC log.p_UpdateETLTableLoadLog @ETLTableLoadLogID, 3, 'Failed', @InsertedCount, @UpdatedCount, @DeletedCount, @ErrorMessageEXEC log.p_UpdateETLLog @ETLLogID, 3, 'Failed';THROWEND CATCH